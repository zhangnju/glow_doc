<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Glow: How to implement a new operator in Glow</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Glow
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">How to implement a new operator in Glow </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Note: It's best to avoid implementing new Glow IR nodes and instructions. If support for a new operator is needed, it's best to first check to see if this operator can be implemented using an existing glow IR node or nodes. For example FCTransposed can be implemented using a regular FC node. If this is the case then the operator can be implemented by instantiating existing glow IR nodes in the loader or by simply creating a new node creation method in <code>Graph/Graph.cpp</code> which would create the sequence of operators that implements the new operator. Only in the event that this is not possible should new Glow IR nodes/instructions be created.</em></p>
<blockquote class="doxtable">
<p>Example PR: <a href="https://github.com/pytorch/glow/pull/2334">https://github.com/pytorch/glow/pull/2334</a> </p>
</blockquote>
<h3>Implementation</h3>
<h4>High level IR</h4>
<ul>
<li>Create a new Glow high level IR node in <code>ClassGen/NodeGen.cpp</code>. Run <code>ninja all</code> to generate the node. In the build directory, check <code><a class="el" href="_auto_gen_nodes_8h_source.html">glow/AutoGenNodes.h</a></code> to ensure the node has been generated.</li>
<li>Implement the <code>verify()</code> method for the new node in <code>Graph/Nodes.cpp</code>.</li>
<li>Implement a node creation method in <code>Graph/Graph.cpp</code>.</li>
<li>Implement logic to load model that contains the operator in <code>Importer/Caffe2ModelLoader.cpp</code> or <code>Importer/ONNXModelLoader.cpp</code> depending on which type of model the operator comes from. Add the operator to <code><a class="el" href="_common_operator_loader_8h_source.html">Importer/CommonOperatorLoader.h</a></code> instead if the loading logic can be shared between Caffe2 and ONNX. Add as much validation logic as possible here in the loader for the operator because it's crucial to catch errors at this stage. Once the operator is loaded, it is assumed that Glow will be able to successfully run the operator so any issues must be caught here. <h4>Low level IR</h4>
</li>
</ul>
<ul>
<li>Create a new Glow low level IR instruction in <code>ClassGen/InstrGen.cpp</code>.</li>
<li>If a custom translation from high level IR node to low level IR instruction is necessary then implement a new case in <code>IR/IRGen</code> otherwise just use <code>autoIRGen(name)</code> in the definition of the new IR instruction in <code>ClassGen/InstrGen.cpp</code>. <code>autoIRGen(name)</code> will create code to automatically generate IR at compile time from the high level IR node with the name <code>name</code>. If the high level IR node as the same name as the low level instruction then the <code>name</code> parameter can be omitted.</li>
<li>If the new node can be natively supported on some backends but not all backends then consider implementing a lowering in <code>Optimizer/Lower.cpp</code> to lower the high level IR node to other high level IR nodes instead of generating the low level IR instruction for the backends which cannot natively implement the new instruction.</li>
<li>Implement the interpreter implementation of the instruction in <code>Interpreter/InterpreterNodes.cpp</code>. An implementation for interpreter backend is required for all instructions but implementations for other backends are encouraged as well. For example, it's strongly encouraged to also create a CPU implementation for each instruction because of the significantly greater performance of the CPU backend over the interpreter.</li>
</ul>
<h3>Testing</h3>
<ul>
<li>Test the operator implementation by writing unit tests in <code>unittests/OperatorTest.cpp</code>.</li>
<li>Test the operator importing logic by creating a new model in <code>tests/models/caffe2Models</code> or <code>tests/models/onnx2Models</code> directory then write unit tests in <code>unittests/Caffe2ImporterTest.cpp</code> or <code>tests/unittests/OnnxImporterTest.cpp</code> using that model.</li>
</ul>
<h3>PR</h3>
<ul>
<li>../PULL_REQUEST.md "Create a pull request" and prefix the title with "[New operator]". </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
